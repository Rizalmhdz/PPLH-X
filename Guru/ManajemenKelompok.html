<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPLH</title>
    <link rel="stylesheet" href="css/datasiswa.css">
    <link rel="stylesheet" href="../fontawesome/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>
    <!-- ADDITIONAL JQUERY -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" charset="UTF-8"></script>
</head>

<style>
    td.upper_line { border-top:solid 1px black; }
    table.fraction { text-align: center; vertical-align: middle;
        margin-top:0.5em; margin-bottom:0.5em; line-height: 2em; }
    
    img{
        border: 1px solid #000000;
        margin: 10px;
    }

    .accordion {
  background-color: #eee;
  color: #444;
  cursor: pointer;
  padding: 18px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 15px;
  transition: 0.4s;
}

.active, .accordion:hover {
  background-color: #ccc;
}

.panel {
  padding: 0 18px;
  background-color: white;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.2s ease-out;
}

</style>

<body>
    <!-- HEADER AREA START-->
    <input type="checkbox" id="check">
    <header>
      <label for="check">
          <i class="fas fa-bars" id="sidebar_btn"></i>
      </label>
      <div class="left_area">
          <a href="../index.html"><h3>PPLH</h3></a>
      </div>
      <div class="right_area">
        <a id="logout" href="../index.html" class="logout_btn"><i class="fa fa-sign-out"></i></a>
        <h5 id="nama" style><i class="fa-solid fa-user"></i></h5>
      </div>
      <div class="progress-container">
          <div class="progress-bar" id="myBar"></div>
      </div> 
  </header>
    <!-- HEADER AREA END tulis tahap-->

    <!-- SIDEBAR START -->
    <nav class="sidebar">
        <div class="profile_info">
            <h3><b>Menu</b></h3>
            <hr style="width: 90%; background-color: white !important; margin: 5px 0 5px 0; height:3px !important;" >
        </div>
        <ul>
            <li><a href="datasiswa.html" class="menu-btn"><i class="fa-solid fa-user"></i>&ensp;Daftar Siswa</a></li>
            <li><a href="NilaiAktifitas.html" class="menu-btn"><i class="fa-regular fa-address-book"></i>&ensp;Nilai Aktifitas</a></li>
            <li><a href="NilaiLatihan.html" class="menu-btn"><i class="fa-solid fa-clipboard-list"></i>&ensp;Nilai Latihan</a></li>
            <li><a href="KuisdanEvaluasi.html" class="menu-btn"><i class="fa-solid fa-square-poll-vertical"></i>&ensp;Nilai Kuis dan Evaluasi</a></li>
            <li id="active"><a href="#" class="menu-btn" id="hitam"><i class="fa-solid fa-people-group"></i></i>&ensp;Manajemen Kelompok</a></li>
            <li><a href="ArsipKelompok.html" class="menu-btn"><i class="fa-solid fa-users"></i>&ensp;Arsip Kelompok</a></li>
      </ul>
    </nav>
    <!-- SIDEBAR END -->

    <!-- CONTENT AREA START-->
    <div class="content">
    <!-------------------------------------------------------- Nilai Kuis dan Evaluasi ------------------------------------------------------------------>
      <div class="card-header"><center>Manajemen Kelompok</center></div>
        <!-----------------------------------------------Modal Tambah Data Siswa ------------------------------------------------------->
        <!-- <div class="modal fade" id="tambahModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered " >
              <div class="modal-content" style="background-color: white;">
                <div class="modal-header">
                  <h5 class="modal-title fw-bold text-dark " id="exampleModalLabel">TAMBAH DATA</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" >
                  <div class="popup add">
                    <form action="" style="background-color: white;">
                      <div class="mb-3">
                        <label>NISN :</label>
                        <input type="text" class="form-control" id="tambahNisnbox">
                      </div>
                      <div class="mb-3">
                        <label>Nama :</label>
                        <input type="text" class="form-control" id="tambahNamabox">
                      </div>
                      <div class="mb-3">
                        <label>Kelas :</label>
                        <input type="text" class="form-control" id="tambahKelasbox">
                      </div>
                      <div class="mb-3">
                        <label>Kelompok :</label>
                        <input type="text" class="form-control" id="tambahKelompokbox">
                      </div>
                      <div class="mb-3">
                        <label>Password :</label>
                        <input type="text" class="form-control" id="tambahPasswordbox">
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Kembali</button>
                        <button type="submit" class="btn btn-success" id="submit">Tambah</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
         -->
        <br>

        <!-------------------------------------------------------------Tabel Siswa ----------------------------------------------------------->
        
        <button class="btn align-text-right" data-bs-toggle="modal" data-bs-target="#tambahModal" id="tambah" style="background-color: #AAD8D3; color: #555; margin-right: 9px;">Tambah Kelompok</button>
                
        <div class= "content-card" id="menu-show1">
          <div class="table-responsive-sm container mt-3">
            <table class="table text-center table-bordered" style="border-color: #555;background-color: #fff; color: #555;">
                <thead class="text-center" style="border-color: #555;background-color: #AAD8D3; color: #555;">
                    <tr>
                        <th>No.</th>
                        <th>Kelompok</th>
                        <th>Token</th>
                        <th>Pengawas</th>
                        <th>Aksi</th>
                        
                      </tr>
                </thead>
                <tbody id="tbody1"></tbody>
                
            </table>
        </div>
        </div>

         <!-- Modal Tambah Kelas -->
         <div class="modal fade" id="tambahModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered " >
              <div class="modal-content" style="background-color: white;">
                <div class="modal-header">
                  <h5 class="modal-title fw-bold text-dark " id="exampleModalLabel">TAMBAH KELOMPOK</h5>
                  <button type="button" class="btn-close delete-progress"  aria-label="Close"></button>
                </div>
                <div class="modal-body" >
                  <div class="popup add">
                    <form action="" style="background-color: white;">
                      <div class="mb-3">
                        <label>Kelompok :</label>
                        <input type="text" class="form-control" id="namaKelas" required>
                      </div>
                      <div class="mb-3">
                        <label>Token :</label>
                        <input type="text" class="form-control" id="tokenKelas" required
                      </div>
                      <div class="mb-3">
                        <label>Guru Pengawas :</label>
                        <select class="form-control" id="pengawasKelompok" required>
                        </select>
                      </div>
                    
                      <div class="modal-footer">
                        <button type="button" class="btn btn-primary delete-progress">Kembali</button>
                        <button type="submit" class="btn btn-success" id="tambahBtn">Tambah</button>
                        <button type="button" class="btn btn-warning" id="simpanBtn">Simpan</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
        </div>

          
        
        <!--------------------------------------------------------------Footer -------------------------------------------------------------->
        <!-- <div class="footer-nav">
            <a href="#" class="footer-number">Sebelumnya</a>
            <a href="#" class="footer-number">1</a>
            <a href="#" class="footer-number">2</a>
            <a href="#" class="footer-number">3</a>
            <a href="#" class="footer-number">Selanjutnya</a>
        </div> -->
    </div>

    <style>
      .floating-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000; /* untuk memastikan tombol muncul di atas konten lain */
      }
  
      .chat-room {
          z-index: 1000;
        width: 400px;
        height: 500px;
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #fff;
        border: 1px solid #424242;
        border-radius: 5px;
      }
  
      .chat-header {
        background-color: #AAD8D3;
        color: #fff;
        padding: 10px;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
      }
  
      .chat-body {
        overflow-y: auto;
        padding: 10px;
        height: calc(100% - 140px);
      }
  
      .chat-footer {
          margin-bottom: 0;
        padding: 10px;
        border-top: 1px solid #ccc;
        display: flex; /* Mengatur elemen dalam satu baris */
        align-items: center; /* Menyelaraskan elemen secara vertikal */
      }
  
      .bubble {
        max-width: 70%;
        margin-bottom: 10px;
        clear: both;
        overflow: hidden;
        padding: 10px;
        border-radius: 10px;
        word-wrap: break-word;
      }
  
      .bubble.me {
        float: right;
        background-color: #007bff;
        color: #fff;
      }
  
      .bubble.other {
        float: left;
        background-color: #28a745;
        color: #fff;
      }
  
      .chat-time {
        font-size: 0.8em;
        float: right;
      }
      .close-btn {
          margin-top: -30px;
          float: right;
      }

      /* Style untuk elemen input teks */
      #messageInput {
          width: calc(100% - 60px); 
          border: 2px solid #AAD8D3; 
          border-radius: 5px; 
          margin-right: 10px; 
          box-sizing: border-box; 
      }

      /* Style untuk tombol kirim */
      #sendButton {
          width: 40px; 
          height: 40px; 
          background-color: #AAD8D3; 
          border: none; 
          border-radius: 100%; 
          color: #fff;
          font-size: 1.2em; 
          cursor: pointer;
      }
      #sendButton:hover{
          background-color: #2F323A; 
      }
    </style>
       <!-- Floating Button -->
<!-- Floating Button -->
<!-- <button id="floatingButton" class="btn btn-primary floating-button">Chat</button> -->

<!-- Popup untuk room chat -->
<div id="chatPopup" class="chat-room" style="display: none;">
<div class="chat-header">
<h4 class="mt-2 ms-2" id="namaKelompokRoomChat">Nama Kelompok</h4>
  <button type="button" class="btn-close close-btn" id="closeChat" aria-label="Close"></button>
  <div class="ms-2" id="anggota-kelompok-chat">
      
  </div>
</div>
<div class="chat-body" id="chatMessages"></div>
<div class="chat-footer">
<input type="text" class="form-control" id="messageInput" placeholder="Ketik pesan...">
<button type="button" class="btn btn-block" id="sendButton""><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
  <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
</svg></button>
</div>
</div>
    
    <!--CONTENT AREA END -->
    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
    <script type="module">
      //---------project setting firebase-----------
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
      
      const firebaseConfig = {
          apiKey: "AIzaSyBAEK9blcK9ZjeIT8kPPWk8_xv7jgwjYQo",
          authDomain: "pplh-70ccb.firebaseapp.com",
          databaseURL: "https://pplh-70ccb-default-rtdb.firebaseio.com",
          projectId: "pplh-70ccb",
          storageBucket: "pplh-70ccb.appspot.com",
          messagingSenderId: "823611849079",
          appId: "1:823611849079:web:a0f8c81197a46a2e1dc972"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);

      import { getDatabase, ref, child, onValue, get, set, query, remove, orderByChild, onChildAdded, equalTo, update, orderByKey, limitToLast}
      from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
      
      const db = getDatabase();
      //-------------------------------------------------------------Menampilkan semua data siswa--------------------------------------------
      //---------------------filling the table-------------
      var stdNo = 0;
      var tbody = document.getElementById('tbody1');
      tbody.innerHTML = "";
      let kelas = document.getElementById('kelasInp');
      let nama = document.getElementById('nameInp');
      let nim = document.getElementById('nimInp');
      let password = document.getElementById('passInp');
      let kelasT = document.getElementById("namaKelas");
      let token = document.getElementById("tokenKelas");
      let pengawasKelompok = document.getElementById("pengawasKelompok");

      console.log(kelasT.value);

      
      let guru = {};
      // Mendengarkan perubahan pada path 'dataGuru'
     onValue(ref(db, "dataGuru/"), (snapshot) => {
         // Mendapatkan nilai dari snapshot (data guru)
         const data = snapshot.val();
         for (const key in data) {
             // Menyimpan username sebagai kunci dan nama sebagai nilai dalam objek guru
             if (!guru[data[key].username]) {
              guru[data[key].username] = {}; // Inisialisasi objek jika belum terdefinisi
            }
             guru[data[key].username].nama = data[key].name;
             
         }
         console.log(guru)
         
     });

      let kelasfix = "";
      let cek11 = 0;

      let tmp = document.querySelector('#tbody1');
      const que = query(ref(db, "dataKelompok/"), orderByChild("nisn"));
                          onValue(que, (snapshot) => {
                                console.log(snapshot.val());
                                tmp.innerHTML = "";
                                var no = 1;
                                const users = snapshot;
                                users.forEach(user => {
                                  const userVal = user.val();
                                  let pengawas = guru[userVal.pengawas].nama
                                   // Pastikan guru[userVal.pengawas] sudah terdefinisi
                                  if (!guru[userVal.pengawas]) {
                                    guru[userVal.pengawas] = {}; // Inisialisasi objek jika belum terdefinisi
                                  }
                                   // Pastikan kelompok sudah didefinisikan dan merupakan array
                                  if (!Array.isArray(guru[userVal.pengawas].kelompok)) {
                                    guru[userVal.pengawas].kelompok = []; // Inisialisasi kelompok sebagai array kosong jika belum terdefinisi
                                  }
                                   guru[userVal.pengawas].kelompok.push(userVal.kelompok)
                                    console.log(guru)
                                    let tr = `
                                        <tr data-id = ${user.key}>
                                          <td>${no}</td>
                                          <td>${userVal.kelompok}</td>
                                          <td>${userVal.token}</td>
                                          <td>${pengawas}</td>
                                          <td>
                                            
                                            <button class="chat btn btn-primary" id="chat-${userVal.kelompok}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-right-text" viewBox="0 0 16 16">
                                              <path d="M2 1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h9.586a2 2 0 0 1 1.414.586l2 2V2a1 1 0 0 0-1-1zm12-1a2 2 0 0 1 2 2v12.793a.5.5 0 0 1-.854.353l-2.853-2.853a1 1 0 0 0-.707-.293H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2z"/>
                                              <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5M3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6m0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5"/>
                                            </svg></button>
                                            <button class="edit btn btn-warning" id="edit-${userVal.kelompok}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                                            <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z"/>
                                          </svg></button>
                                          <button class="delete btn btn-danger" id="delete-${userVal.kelompok}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                                          </svg></i></button></td>
                                                                                    
                                        <tr>
                                        `;
                        
                                  tmp.innerHTML += tr;
                                  no++;
                                //////////////////////////////////////////////////////////

                                //Delete
                                let deleteButtons = document.querySelectorAll(".delete");
                                deleteButtons.forEach((deleteBtn) => {
                                  deleteBtn.addEventListener("click", () => {
                                  
                                      Swal.fire({
                                      title: 'Apa kamu yakin mengapus data?',
                                      text: '',
                                      icon: 'question',
                                      showCancelButton: true,
                                      confirmButtonColor: '#3085d6',
                                      cancelButtonColor: '#d33',
                                      confirmButtonText: 'Iya',
                                      cancelButtonText: 'Batal',
                                    }).then((result) => {
                                      if (result.value) {
                                        
                                        
                                        const db = getDatabase();
                                        let userId = deleteBtn.parentElement.parentElement.dataset.id;
                                        remove(ref(db, "dataKelompok/" + userId));
                                        
                                        Swal.fire({
                                          title: "Selamat!",
                                          text: "Data berhasil dihapus.",
                                          icon: "success",
                                          button: "Lanjutkan",
                                        });
                                        
                                      }
                                    });
                                  
                                  
                                  });
                                });
                                //////////////////////////////////////////////////////////

                                //edit
                                let editButtons = document.querySelectorAll(".edit");
                                editButtons.forEach((editButton) => {
                                  editButton.addEventListener("click", () => {
                                    $('#tambahModal').modal('show');
                                    
                                    namaKelompok.value = "";
                                    tokenKelompok.value = "";
                                    pengawasKelompok.innerHTML = "";
                                    simpanBtn.style.display = "block";
                                    tambahBtn.style.display = "none";
                                    const extractedId = editButton.id.replace('edit-', '');

                                    // Mendapatkan nilai dari spesifik path
                                    get(ref(db, "dataKelompok/" + extractedId)).then((snapshot) => {
                                      if (snapshot.exists()) {
                                          // Jika nilai pada path tersebut ada
                                          const value = snapshot.val();
                                          namaKelompok.value = value.kelompok
                                          tokenKelompok.value = value.token
                                          pengawasKelompok.innerHTML += '<option value = "" disable>---- Pilih Guru Pengawas ----</option>';
                                          const selectElement = pengawasKelompok;
                                          for (const key in guru) {
                                            const option = document.createElement('option');
                                            option.value = key;
                                            option.text = guru[key]; 
                                             // Tambahkan kondisi untuk menandai opsi tertentu sebagai terpilih
                                            if (key === value.pengawas) {
                                              option.selected = true;
                                            }// Ubah 'nama' sesuai dengan properti yang Anda inginkan
                                            selectElement.appendChild(option);
                                          }
                                          
                                          // Lakukan sesuatu dengan nilai
                                      } else {
                                          // Jika nilai pada path tersebut tidak ada
                                          console.log("Nilai pada spesifik path tidak ditemukan.");
                                      }
                                    }).catch((error) => {
                                      // Menangani kesalahan jika ada
                                      console.error("Error:", error);
                                    });
                                    });
                                });
                                //////////////////////////////////////////////////////////
                                  
                                //edit
                                let chatButtons = document.querySelectorAll(".chat");
                                chatButtons.forEach((chatButton) => {
                                  const extractedId = chatButton.id.replace('chat-', '');
                                  if(!guru[username].kelompok.includes(extractedId)){
                                    chatButton.disabled = true;
                                  } else {
                                    chatButton.addEventListener("click", () => {
                                      document.getElementById('chatPopup').style.display = 'block';
                                      scrollToBottom();
                                      sortirBadgeAnggotaKelompok();
                                      
                                      });
                                  }
                                  
                                });
                                //////////////////////////////////////////////////////////
                                  

                                })
                                

                              });

    // Menambahkan data ke tabel
    var stdNo = 0;
                              var tbody = document.querySelector("tbody1");
                              var addUser = document.querySelector("#tambah"),
                                popup = document.querySelector(".popup"),
                                addform = document.querySelector(".add form"),
                                updateform = document.querySelector(".update form");

                        
                              function writeUserData(kelas, token, pengawasKelompok, status) {
                                set(ref(db, "dataKelompok/" + kelas), {
      
                                  kelompok: kelas,
                                  token: token,
                                  pengawas : pengawasKelompok,
                                })
                                  .then(() => {
                                    Swal.fire({
                                          title: "Selamat!",
                                          text: `Kelompok berhasil di${status}`,
                                          icon: "success",
                                          button: "Lanjutkan",
                                        });
                                    addform.reset();
                                  $('#tambahModal').modal('hide');
                                  })
                                  .catch((errorr) => {
                                    Swal.fire({
                                          title: "Maaf!",
                                          text: `Kelompok gagal di${status}.`,
                                          icon: "error",
                                          button: "Lanjutkan",
                                        });
                                  });
                              }

                               // Mengambil data siswa dari Firebase
                               let tambahKelompok = document.getElementById("tambah")
                               tambahKelompok.addEventListener("click", () => {
                                pengawasKelompok.innerHTML = '<option value = "" disable>---- Pilih Guru Pengawas ----</option>';
                                const selectElement = pengawasKelompok;
                                for (const key in guru) {
                                  const option = document.createElement('option');
                                  option.value = key;
                                  option.text = guru[key]; // Ubah 'nama' sesuai dengan properti yang Anda inginkan
                                  selectElement.appendChild(option);
                                }
                               })

                              

                            const exitModal = document.querySelectorAll('.delete-progress');

                            // Loop melalui setiap elemen dan tambahkan event listener
                            exitModal.forEach(function(tombol) {
                                tombol.addEventListener('click', function() {
                                    // Panggil fungsi yang sama saat salah satu tombol diklik
                                    deleteProgress();
                                });
                            });


                            let namaKelompok = document.getElementById('namaKelas');
                            let tokenKelompok = document.getElementById('tokenKelas');
                            function deleteProgress(){
                              Swal.fire({
                                title: 'Ingin menghapus progress saat ini?',
                                text: '',
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Iya',
                                cancelButtonText: 'Batal',
                              }).then((result) => {
                                if (result.value) {
                                  $('#tambahModal').modal('hide');
                                  namaKelompok.value = "";
                                  tokenKelompok.value = "";
                                  pengawasKelompok.innerHTML = "";
                                  
                                  Swal.fire({
                                    title: "Selamat!",
                                    text: "Data berhasil dihapus.",
                                    icon: "success",
                                    button: "Lanjutkan",
                                  });
                                  
                                }
                              });
                            }

                                                          
                              let simpanBtn = document.getElementById('simpanBtn');
                              let tambahBtn = document.getElementById('tambahBtn');

                              
                              simpanBtn.addEventListener("click", (e) => {
                                    e.preventDefault();
                                    writeUserData(kelasT.value, token.value, pengawasKelompok.value, "-edit");
                              });


                              addUser.addEventListener("click", () => {
                                  // document.querySelector(".add").classList.add("active");
                                  simpanBtn.style.display = "none";
                                  tambahBtn.style.display = "block";
                                  addform.addEventListener("submit", (e) => {
                                    e.preventDefault();
                                    writeUserData(kelasT.value, token.value, pengawasKelompok.value, "simpan");
    
                                  });
                                });



// ================================= CHAT KELOMPOK ========================================
let anggota_kelompok = {}
let groupUser = "";


    const queGroup = query(ref(db, "dataKelompok/"));
    onValue(queGroup, (snapshot) => {
        // Memproses snapshot yang berisi nilai terbaru dari path tersebut
        if (snapshot.exists()) {
            // Jika snapshot tidak kosong
            snapshot.forEach((groupSnapshot) => {
                const group = groupSnapshot.val();
                if (group.pengawas == username) {
                    groupUser += group.kelompok;
                    console.log("Kelompok Guru:", groupUser);
                    // Lakukan sesuatu dengan data
                }
            });
        } else {
            // Jika snapshot kosong
            console.error("Data tidak ditemukan");
        }
    }, (error) => {
        // Menangani kesalahan jika ada
        console.error("Error:", error);
    });

    let anggotKelompokChat = document.getElementById("anggota-kelompok-chat");
    $('#namaKelompokRoomChat').text("Kelompok " + groupUser)

    function tambahAnggotaGroupBadge(nama, konfirmasi){
        // Membuat elemen span baru
        var newSpan = document.createElement("span");
        newSpan.className = `me-1 badge text-bg-${konfirmasi == true? "success" : "danger"}`; // Menetapkan kelas CSS

        // Membuat teks yang akan ditampilkan di dalam span
        var newText = document.createTextNode(`${nama===nm? "Anda" : nama}`);

        // Menambahkan teks ke dalam elemen span
        newSpan.appendChild(newText);

        // Menambahkan elemen span ke dalam elemen anggotKelompokChat
        anggotKelompokChat.appendChild(newSpan);
    }

    
    

    let chatPopup = document.getElementById('chatPopup');
        

        let closeChat = document.getElementById('closeChat')
        closeChat.addEventListener('click', function(){
          chatPopup.style.display = 'none';
        })
    
    
        function createBubbleMsg(sender, message, time){
              var bubble = document.createElement('div');
              bubble.textContent = message;
        
              if (sender === username) {
                var bubbleClass = 'bubble-me';
                bubble.style.float = 'right';
                bubble.style.backgroundColor = '#AAD8D3';
                bubble.style.paddingTop = '10px'; 
                bubble.style.minWidth = '50px';
                
              } else {
                bubble.style.float = 'left';
                bubble.style.backgroundColor = '#2F323A';
                bubble.style.paddingTop = '30px'; 
    
                var senderSpan = document.createElement('span');
                senderSpan.textContent = anggota_kelompok[sender];
                senderSpan.style.fontSize = '0.8em';
                senderSpan.style.position = 'absolute';
                senderSpan.style.top = '10px'; 
                senderSpan.style.left = '10px'; 
                senderSpan.style.paddingRight = '20px'; 
                senderSpan.style.fontWeight = 'bold';
                
    
                bubble.appendChild(senderSpan);

                bubble.style.minWidth = anggota_kelompok[sender].length * 0.8 + 'em'; // Mengatur lebar minimum bubble
              }
        
              bubble.style.color = '#fff';
              bubble.style.borderRadius = '10px';
              bubble.style.maxWidth = '80%';
              bubble.style.marginBottom = '10px';
              bubble.style.clear = 'both';
              bubble.style.overflow = 'hidden';
              bubble.style.paddingLeft = '10px'; 
              bubble.style.paddingBottom = '20px'; 
              bubble.style.wordWrap = 'break-word';
              bubble.style.position = 'relative'; // Container bubble chat harus dalam posisi relatif

        
              var timeSpan = document.createElement('span');
              timeSpan.textContent = time;
              timeSpan.style.fontSize = '0.6em';
              timeSpan.style.position = 'absolute';
              timeSpan.style.bottom = '5px'; 
              timeSpan.style.right = '5px'; 
              timeSpan.style.padding = '0 5px'; // Padding kiri-kanan minimum untuk span waktu
        
              
        
              // Tambahkan timeSpan ke dalam bubble
              bubble.appendChild(timeSpan);
              
              var chatMessages = document.getElementById('chatMessages');
              chatMessages.appendChild(bubble);
        }
    
        function getTimeStamp(){
            // Mendapatkan tanggal dan waktu saat ini
            const currentDateTime = new Date();
    
            // Mendapatkan tahun
            const year = currentDateTime.getFullYear();
    
            // Mendapatkan bulan (dalam format dua digit)
            const month = String(currentDateTime.getMonth() + 1).padStart(2, '0');
    
            // Mendapatkan tanggal (dalam format dua digit)
            const date = String(currentDateTime.getDate()).padStart(2, '0');
    
            // Mendapatkan jam (dalam format dua digit)
            const hours = String(currentDateTime.getHours()).padStart(2, '0');
    
            // Mendapatkan menit (dalam format dua digit)
            const minutes = String(currentDateTime.getMinutes()).padStart(2, '0');
    
            // Mendapatkan detik (dalam format dua digit)
            const seconds = String(currentDateTime.getSeconds()).padStart(2, '0');
    
            // Mendapatkan milidetik (dalam format tiga digit)
            const milliseconds = String(currentDateTime.getMilliseconds()).padStart(3, '0');
    
            // Gabungkan semua komponen untuk membuat timestamp dalam format yang diinginkan
            const timestamp = `${year}${month}${date}${hours}${minutes}${seconds}${milliseconds}`;
    
            return timestamp
        }
        
        let sendButton = document.getElementById('sendButton')
        sendButton.addEventListener('click', function(){ 
            sendMessage();
        });

        function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            const currentTime = new Date();
            const options = { hour: '2-digit', minute: '2-digit', hour12: false };
            const formatter = new Intl.DateTimeFormat('id', options);
            const formattedTime = formatter.format(currentTime);
        
            if (message !== '') {
             const chatMessages = document.getElementById('chatMessages');
    
              set(ref(db, 'dataKelompok/'+ groupUser + '/chatGroup/'+getTimeStamp()), {
                usnPengirim : nisnUser,
                pesan : message,
                pada  : formattedTime
              });
    
            // Auto-scroll ke paling bawah saat ada chat baru
            chatMessages.scrollTop = chatMessages.scrollHeight;
        
            // Kosongkan input teks setelah mengirim
            document.getElementById('messageInput').value = '';
        
            }
        }

        console.log("isConfirmUser : " + isConfirmUser)


        function createTooltip(item, pesan){
            item.addEventListener('mouseover', function() {
                // Buat elemen tooltip
                const tooltip = document.createElement('div');
                tooltip.textContent = pesan;
            
               // Gaya untuk tooltip
                tooltip.style.position = 'absolute';
                tooltip.style.background = '#333';
                tooltip.style.color = '#fff';
                tooltip.style.padding = '5px';
                tooltip.style.borderRadius = '5px';
                tooltip.style.right = '20px'; // Letakkan di samping kiri tombol
                tooltip.style.bottom = '-290px'; // Letakkan di atas tombol
                        
                // Menambahkan tooltip ke dalam dokumen
                document.body.appendChild(tooltip);
            
                // Menghapus tooltip setelah beberapa detik (opsional)
                setTimeout(function() {
                    tooltip.parentNode.removeChild(tooltip);
                }, 2000);
            });
        }
        


        document.getElementById('chatMessages').addEventListener('scroll', function() {
            var floatingButtonDown = document.getElementById('floatingButtonDown');
        
            // Jika posisi scroll tidak berada di bagian paling bawah
            if (this.scrollTop < (this.scrollHeight - this.clientHeight)) {
                // Munculkan floating button down
                if (!floatingButtonDown) {
                    floatingButtonDown = document.createElement('button');
                    floatingButtonDown.id = 'floatingButtonDown';
                    floatingButtonDown.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#2F323A" class="bi bi-arrow-down" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1"/>
                    </svg>`;
                    floatingButtonDown.style.position = 'absolute';
                    floatingButtonDown.style.bottom = '80px'; 
                    floatingButtonDown.style.right = '40px';
                    floatingButtonDown.style.width = '40px'; 
                    floatingButtonDown.style.height = '40px'; 
                    floatingButtonDown.style.borderRadius = '50%';
                    floatingButtonDown.style.border = '2px solid #2F323A'; 
                    floatingButtonDown.style.backgroundColor = '#fff'; 
                    floatingButtonDown.style.cursor = 'pointer';
                    floatingButtonDown.onclick = function() {
                        var chatMessages = document.getElementById('chatMessages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    };
        
                    document.getElementById('chatPopup').appendChild(floatingButtonDown);
                }
            } else {
                // Sembunyikan floating button down jika posisi scroll berada di bagian paling bawah
                if (floatingButtonDown) {
                    floatingButtonDown.parentNode.removeChild(floatingButtonDown);
                }
            }
        });

function loadMessages() {
    const groupChatRef = ref(db, 'dataKelompok/' + groupUser + '/chatGroup/');

    // Mengurutkan data berdasarkan kunci secara menurun dan membatasi hanya 20 data terakhir
    const que = query(groupChatRef, orderByKey());

    // Mendapatkan data dengan query yang sudah dibuat
    onChildAdded(que, (snapshot) => { // Menggunakan onChildAdded untuk hanya mendapatkan pesan baru
        const chatData = snapshot.val();
        createBubbleMsg(chatData.usnPengirim, chatData.pesan, chatData.pada);
       
    });
}

function scrollToBottom(){
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}


// Memuat pesan saat halaman dimuat
document.addEventListener('DOMContentLoaded', () => {
    loadMessages();
});
          
    function sortirBadgeAnggotaKelompok(){
            var spans = document.querySelectorAll("#anggota-kelompok-chat span");
    
            // Membuat array dari nodeList
            var spansArray = [];
    
           // Memasukkan elemen-elemen <span> ke dalam array sementara dan melakukan penggantian nama jika terdiri dari dua kata atau lebih
            spans.forEach(function(span) {
                var text = span.textContent.trim();
                var name = extractName(text);
                if (name.includes(' ')) {
                    name = name.split(' ')[1];
                }
                span.textContent = name;
                spansArray.push({ element: span, name: name });
            });
    
            // Fungsi untuk mengekstrak nama dari teks dan mengembalikan kata kedua jika ada
            function extractName(text) {
                var words = text.split(' ');
                if (words.length > 1) {
                    return words[1];
                }
                return text;
            }
    
            // Mengurutkan elemen-elemen <span> yang tersisa berdasarkan teks yang ada di dalamnya
            spansArray.sort(function(a, b) {
                var textA = a.name.toLowerCase();
                var textB = b.name.toLowerCase();
                return textA.localeCompare(textB);
            });
    
            // Mencari index elemen <span> yang berisi teks "Anda"
            var indexAnda = -1;
            spansArray.forEach(function(span, index) {
                var spanText = span.name.trim();
                if (spanText === "Anda") {
                    indexAnda = index;
                }
            });
    
            // Jika elemen <span> yang berisi teks "Anda" ditemukan
            if (indexAnda !== -1) {
                // Memindahkan elemen <span> yang berisi teks "Anda" ke urutan pertama
                var spanAnda = spansArray.splice(indexAnda, 1)[0];
                spansArray.unshift(spanAnda);
            }
    
            // Mendapatkan parent dari elemen <span>
            var parentElement = document.getElementById("anggota-kelompok-chat");
    
            // Menghapus semua elemen <span> dari parent
            parentElement.innerHTML = "";
    
            spansArray.forEach(function(span) {
                parentElement.appendChild(span.element);
            });
       
    }

    // =======================================================================================
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    let nama2 = document.getElementById('nama');
    let nm = sessionStorage.getItem('nama');
    let username = sessionStorage.getItem('username');

    nama2.innerHTML = `<i class="fa-solid fa-user"></i> ${nm}`;

    let logout = document.getElementById("logout");
    logout.addEventListener("click", ()=>{
        // Membersihkan session storage
        sessionStorage.clear();
    });
    isConfirmUser = true;
  </script>
</body> 
</html>

    <!-- JAVASCRIPT AREA END -->