<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPLH</title>
    
    <link rel="stylesheet" href="../css/stylekikd.css">
    <link rel="stylesheet" href="../fontawesome/fontawesome/css/all.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- ADDITIONAL JQUERY -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" charset="UTF-8"></script>
    <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml.min.js"></script>
</head>

<style>
    td.upper_line { border-top:solid 1px black; }
    table.fraction { text-align: center; vertical-align: middle;
        margin-top:0.5em; margin-bottom:0.5em; line-height: 2em; }
    
    img{
        border: 1px solid #000000;
        margin: 10px;
    }
</style>

<body>
    <!-- HEADER AREA START-->
    <!-- HEADER AREA START-->
    <input type="checkbox" id="check">
    <header>
        <label for="check">
            <i class="fas fa-bars" id="sidebar_btn"></i>
        </label>
        <div class="left_area">
            <h3>PPLH</h3>
        </div>
        <div class="right_area">
            <a href="../index.html" class="logout_btn">
                <i class="fas fa-home"></i>
            </a>

            <h5 class="logout_btn" id="nama"></h5>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="myBar"></div>
        </div> 
    </header>
    <!-- HEADER AREA END tulis tahap-->

    <!-- SIDEBAR START -->
    <nav class="sidebar">
        <div class="profile_info">
            <h3>Materi</h3>
            <hr style="width: 90%; color: #fff; margin: 5px 0 5px 0;">
        </div>
        <ul>
            <li><a href="pengantar.html" class="menu-btn"><span class="numbering"></span><span class="numbering_text">Pendahuluan</span> </a></li>
            <li><a href="#" class="menu-btn"><span class="numbering">1.</span><span class="numbering_text">Keseimbangan dan Perubahan Lingkungan Hidup<i class="fas fa-caret-down"></i></span></a>
            <ul class="menu-show">
                <li><a href="Kuis1_PilihanGanda.html"><span class="numbering_text">Kuis 1</span></a></li>
            </ul>
            </li>
            <li><a href="#" class="menu-btn"><span class="numbering">2.</span><span class="numbering_text">Pencemaran Lingkungan Hidup<i class="fas fa-caret-down"></i></span></a>
                <ul class="menu-show">
                    <li><a href="2.1udara.html"><span class="numbering">2.1</span><span class="numbering_text">Pencemaran Udara</span></a></li>
                    <li><a href="2.2Air.html"><span class="numbering">2.2</span><span class="numbering_text">Pencemaran Air</span></a></li>
                    <li><a href="2.3tanah.html"><span class="numbering">2.3</span><span class="numbering_text">Pencemaran Tanah</span></a></li>
                    <li><a href="2.4suara.html"><span class="numbering">2.4</span><span class="numbering_text">Pencemaran Suara</span></a></li>
                 </ul>
            </li>
            <li><a href="3akumulasi.html" class="menu-btn"><span class="numbering">3.</span><span class="numbering_text">Akumulasi Bahan Pencemar dalam Rantai Makanan</span></a>
            <li><a href="#" class="menu-btn"><span class="numbering">4.</span><span class="numbering_text">Penanganan Limbah<i class="fas fa-caret-down"></i></span></a>
                <ul class="dropdown-container">
                    <li><a href="4.1cair.html"><span class="numbering">4.1</span><span class="numbering_text">Penanganan Limbah Cair</span></a></li>
                    <li><a href="#"><span class="numbering">4.2</span><span class="numbering_text">Penanganan Limbah Padat</span></a></li>
                    <li><a href="#"><span class="numbering">4.3</span><span class="numbering_text">Penanganan Limbah Gas</span></a></li>
                    <li><a href="#"><span class="numbering">4.4</span><span class="numbering_text">Penanganan Limbah Bahan Berbahaya dan Beracun (B3)</span></a></li>
                 </ul>
            <li><a href="5dinamika.html" class="menu-btn"><span class="numbering">5.</span><span class="numbering_text">Dinamika Komunitas, Adaptasi dan Mitigasi terhadap Perubahan Lingkungan<i class="fas fa-caret-down"></i></span></a>
                <ul class="menu-show">
                    <li><a href="#"><span class="numbering">5.1</span><span class="numbering_text">Dinamika Komunitas</span></a></li>
                    <li><a href="#"><span class="numbering">5.2</span><span class="numbering_text">Adaptasi dan Mitigasi terhadap Perubahan Lingkungan</span></a></li>
                </ul>
            <li><a href="Evaluasi.html" class="menu-btn"><span class="numbering"></span><span class="numbering_text">Evaluasi</span></a> </li>
        </ul>
    </nav>
    <!-- SIDEBAR END -->

    <!-- CONTENT AREA START-->
    <div class="content">
        <div id="area">
        <!-- <div class="card-header-bab"><center>Kegiatan Kelompok CL 1: Keseimbangan dan Perubahan Lingkungan Hidup</center></div> -->

            <div class="card-header-2" id="menu-btn">Kesimpulan <i class="fas fa-caret-down"></i></div>
            <div class= "content-card">
                <h5 class="text-center mt-4 mb-4">Silakan Menyimpulkan Di Bawah Ini!</h5>
                <div class="container">
                    <!-- Textarea dengan class "form-control" dari Bootstrap -->
                    <textarea id="autoExpandTextarea" class="form-control" placeholder="Ketik di sini..."></textarea>
                    <div id="displayContent" class="container mt-3">
                        <h5>Kesimpulan : <p id="savedContent"></p></h5>
                    </div>
                </div>
                <div class="container mt-2 d-flex justify-content-center">
                    <button id="saveKesimpulan" class="btn btn-success">Simpan</button>
                    <button id="editKesimpulan" class="btn btn-primary">Edit</button>
                </div>
                     
                </div>
            </div>
            <div class="footer-nav">
                <a href="1KeseimbanganLatihan.html" class="footer-number">Sebelumnya</a>
                <a href="Kuis1_PilihanGanda.html" id="nextLink" class="footer-number">Selanjutnya</a>
            </div>

            <!-- <div class="card-header-2" id="menu-btn">Upload <i class="fas fa-caret-down"></i></div>
            <div class= "content-card">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-12 text-center">
                            <h5>Silahkan Cetak hasil Kerjamu, kemudian Upload File Kerjamu dengan Tombol dibawah!</h5>
                        </div>
                    </div>
                </div>
                <center>
                <button class="btn btn-warning mb-4 mt-4" id="cetakBtn">Cetak Hasil Kesimpulan</button>
                <br>
                <input type="file" class="mb-4" id="pdfFile" accept=".pdf">
                <button class="btn btn-success" type="button" id="uploadButton">Upload</button>
                <div class="mt-3" id="progressBar" style="display: none;">
                    <div class="progress">
                      <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </center>
            </div> -->

        </div>
        <!-- <div class="footer-nav">
            <a href="1KeseimbanganLatihan.html" class="footer-number">Sebelumnya</a>
            <a href="Kuis1_PilihanGanda.html" id="nextLink" class="footer-number">Selanjutnya</a>
        </div> -->
        </div>

        <style>
            .floating-button {
              position: fixed;
              bottom: 20px;
              right: 20px;
              z-index: 1000; /* untuk memastikan tombol muncul di atas konten lain */
            }
        
            .chat-room {
                z-index: 1000;
              width: 400px;
              height: 500px;
              position: fixed;
              bottom: 20px;
              right: 20px;
              background-color: #fff;
              border: 1px solid #424242;
              border-radius: 5px;
            }
        
            .chat-header {
              background-color: #AAD8D3;
              color: #fff;
              padding: 10px;
              border-top-left-radius: 5px;
              border-top-right-radius: 5px;
            }
        
            .chat-body {
              overflow-y: auto;
              padding: 10px;
              height: calc(100% - 140px);
            }
        
            .chat-footer {
                margin-bottom: 0;
              padding: 10px;
              border-top: 1px solid #ccc;
              display: flex; /* Mengatur elemen dalam satu baris */
              align-items: center; /* Menyelaraskan elemen secara vertikal */
            }
        
            .bubble {
              max-width: 70%;
              margin-bottom: 10px;
              clear: both;
              overflow: hidden;
              padding: 10px;
              border-radius: 10px;
              word-wrap: break-word;
            }
        
            .bubble.me {
              float: right;
              background-color: #007bff;
              color: #fff;
            }
        
            .bubble.other {
              float: left;
              background-color: #28a745;
              color: #fff;
            }
        
            .chat-time {
              font-size: 0.8em;
              float: right;
            }
            .close-btn {
                margin-top: -30px;
                float: right;
            }

            /* Style untuk elemen input teks */
            #messageInput {
                width: calc(100% - 60px); 
                border: 2px solid #AAD8D3; 
                border-radius: 5px; 
                margin-right: 10px; 
                box-sizing: border-box; 
            }

            /* Style untuk tombol kirim */
            #sendButton {
                width: 40px; 
                height: 40px; 
                background-color: #AAD8D3; 
                border: none; 
                border-radius: 100%; 
                color: #fff;
                font-size: 1.2em; 
                cursor: pointer;
            }
            #sendButton:hover{
                background-color: #2F323A; 
            }

            /* Style agar textarea tetap rapi */
            textarea {
                width: 100%;
                min-height: 100px; /* Tentukan tinggi minimum textarea */
                resize: none; /* Biarkan textarea tidak dapat diubah ukurannya oleh pengguna */
                overflow: hidden; /* Sembunyikan overflow */
            }
            
          </style>
             <!-- Floating Button -->
  <!-- Floating Button -->
  <button id="floatingButton" class="btn btn-primary floating-button">Chat</button>

  <!-- Popup untuk room chat -->
  <div id="chatPopup" class="chat-room" style="display: none;">
    <div class="chat-header">
      <h4 class="mt-2 ms-2" id="namaKelompokRoomChat">Nama Kelompok</h4>
        <button type="button" class="btn-close close-btn" id="closeChat" aria-label="Close"></button>
        <div class="ms-2" id="anggota-kelompok-chat">
            
        </div>
    </div>
    <div class="chat-body" id="chatMessages"></div>
    <div class="chat-footer">
      <input type="text" class="form-control" id="messageInput" placeholder="Ketik pesan...">
      <button type="button" class="btn btn-block" id="sendButton""><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
      </svg></button>
    </div>
  </div>
        
    <!--CONTENT AREA END -->
    
    <!-- JAVASCRIPT AREA START-->
    
        <script src="js/keseimbanganlatihan.js"></script>
        <script src="js/dropdownkonten.js"></script>
        <script>
            function printArea(area){
                var printPage = document.getElementById(area).innerHTML;
                var oriPage = document.body.innerHTML;
                document.body.innerHTML = printPage;
                window.print();
                document.body.innerHTML = oriPage;

            }
        </script>
    <!-- JAVASCRIPT AREA END -->
</body>
<script type="module">
// ====================================== CEGAH BTN SELANJUTNYA JIKA BELUM ADA NILAI DAN UPLOAD FILE ====================

let adaKesimpulan = false
// Fungsi untuk menangani klik pada tautan
document.getElementById("nextLink").addEventListener("click", function(event) {
    if (!adaKesimpulan) {
        // Mencegah perilaku bawaan dari tautan
        event.preventDefault();
        
        // Menampilkan pesan peringatan
        alert("Tambahkan Kesimpulan Terlebih dahulu.");
    }
});


//============================================================================================================
    
    //---------project setting firebase-----------
    import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyBAEK9blcK9ZjeIT8kPPWk8_xv7jgwjYQo",
        authDomain: "pplh-70ccb.firebaseapp.com",
        databaseURL: "https://pplh-70ccb-default-rtdb.firebaseio.com",
        projectId: "pplh-70ccb",
        storageBucket: "pplh-70ccb.appspot.com",
        messagingSenderId: "823611849079",
        appId: "1:823611849079:web:a0f8c81197a46a2e1dc972"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    import { getDatabase, ref, push, child, onValue, get, set, query, remove, orderByChild, onChildAdded, equalTo, update, orderByKey, limitToLast } 
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    
    const db = getDatabase();

    let nm = sessionStorage.getItem('nama');
    let nisnUser = sessionStorage.getItem('nisn');
    let groupUser = sessionStorage.getItem('kelompok');
    let isConfirmUser = sessionStorage.getItem('konfirmasi');
    let floatingBtn = document.getElementById("floatingButton");

// ============================================= CEK HASIL DARI FIREBASE ====================================
let saveKesimpulanBtn = document.getElementById("saveKesimpulan");
let editKesimpulanBtn = document.getElementById("editKesimpulan");
let displayKesimpulan = document.getElementById("displayContent");
let textareaKesimpulan = document.getElementById("autoExpandTextarea");

const pathRefKesimpulan = ref(db, 'dataSiswa/' + nisnUser + '/kerja_kelompok/materi1/kesimpulan');
        
// Gunakan fungsi get() untuk memeriksa keberadaan record pada path tersebut
function getKesimpulan(){
    get(pathRefKesimpulan)
    .then((snapshot) => {
        if (snapshot.exists()) {
            adaKesimpulan =  true;
            let kesimpulan = snapshot.val()
            let kesimpulanElemen = document.getElementById('savedContent')
            kesimpulanElemen.innerHTML = kesimpulan;
            textareaKesimpulan.innerHTML = kesimpulan;
            textareaKesimpulan.style.display = "none"; 
            saveKesimpulanBtn.style.display = "none"; 
            editKesimpulanBtn.style.display = "block"; 
            displayKesimpulan.style.display = "block"; 
        console.log("Record Kesimpulan ditemukan pada path:", pathRefKesimpulan);
        } else {
        console.log("Tidak ada record pada path:", pathRefKesimpulan);
        }
    })
    .catch((error) => {
        console.error("Error:", error);
    });
}

function saveKesimpulan(kesimpulan){
        set(pathRefKesimpulan, kesimpulan)
        .then(() => {
            let kesimpulanElemen = document.getElementById('savedContent')
            kesimpulanElemen.innerText = kesimpulan;
            textareaKesimpulan.value = kesimpulan;
            saveKesimpulanBtn.style.display = "none"; 
            editKesimpulanBtn.style.display = "block"; 
                displayKesimpulan.style.display = "block"; 
            console.log("Record Kesimpulan disimpan pada path:", pathRefKesimpulan);
        })
        .catch((error) => {
            console.error("Error:", error);
        });
    
}

getKesimpulan()


// ====================================== KESIMPULAN =================================


// Fungsi untuk memperluas textarea
function autoExpandTextarea() {
    const textarea = document.getElementById("autoExpandTextarea");
    textarea.style.height = ""; // Menghapus tinggi yang diset sebelumnya agar ukurannya dinamis
    textarea.style.height = `${textarea.scrollHeight}px`; // Set tinggi textarea sesuai dengan ketinggian kontennya
  }
  // Event listener untuk memanggil fungsi autoExpandTextarea saat teks berubah
  textareaKesimpulan.addEventListener("input", autoExpandTextarea);

  editKesimpulanBtn.style.display = "none"; 
  displayKesimpulan.style.display = "none"; 

  // Fungsi untuk menyimpan konten textarea
    saveKesimpulanBtn.addEventListener('click', () => {
        
        const kesimpulan = textareaKesimpulan.value
        if(kesimpulan === ""){
            alert("Kesimpulan Tidak boleh Kosong")
        } else {
            saveKesimpulan(kesimpulan)
        // const savedContent = document.getElementById("savedContent");
        // savedContent.innerHTML = textareaKesimpulan.value; // Menyimpan konten dari textarea ke div
            textareaKesimpulan.style.display = "none"; // Sembunyikan textarea
            saveKesimpulanBtn.style.display = "none"; // Sembunyikan tombol Simpan
            editKesimpulanBtn.style.display = "block"; // Tampilkan tombol Edit
            displayKesimpulan.style.display = "block"; // Tampilkan div yang menampilkan konten
        }
    })
    
    // Fungsi untuk mengedit konten textarea
    editKesimpulanBtn.addEventListener('click', () => {
        //saveKesimpulan()
        textareaKesimpulan.style.display = "block"; // Tampilkan textarea
        saveKesimpulanBtn.style.display = "block"; // Tampilkan tombol Simpan
        editKesimpulanBtn.style.display = "none"; // Sembunyikan tombol Edit
        displayKesimpulan.style.display = "none"; // Sembunyikan div yang menampilkan konten
    })
// ================================= CHAT KELOMPOK ========================================

let anggota_kelompok = {}

const que = query(ref(db, "dataSiswa/"));
onValue(que, (snapshot) => {
    const users = snapshot.val();

    // Objek untuk menyimpan data pengguna yang dikelompokkan berdasarkan kelompok
    const groupedUsers = {};

    // Mengelompokkan pengguna berdasarkan kelompok
    Object.values(users).forEach(user => {
        const kelompok = user.kelompok;
        if (!groupedUsers[kelompok]) {
            groupedUsers[kelompok] = [];
        }
        groupedUsers[kelompok].push(user);
    });

    // Mengurutkan kelompok secara alfabetis
    const sortedGroups = Object.keys(groupedUsers).sort();

    // Membuat baris tabel untuk setiap kelompok
    sortedGroups.forEach(kelompok => {
        const usersInGroup = groupedUsers[kelompok];
        let list = "";
        
        let listFile = "";
        usersInGroup.forEach(user => {
            

            if(user.kelompok == groupUser){ 
                if(!anggota_kelompok[user.kelompok]){ 
                    anggota_kelompok[user.kelompok] = {};
                };
                if(!anggota_kelompok[user.kelompok][user.nisn]){ 
                    anggota_kelompok[user.kelompok][user.nisn] = {};
                };
                anggota_kelompok[user.kelompok][user.nisn] = {
                  nama : user.nama,
                  konfirmasi : user.konfirmasi,
                  guru : false,
                };
            };

           
            
        });
    });
});


const queA = query(ref(db, "dataKelompok/" + groupUser));
onValue(queA, async (snapshot) => {
const usersGroup = snapshot.val();
const usernameGuru = usersGroup.pengawas;

try {
    const specificRef = ref(db, 'dataGuru/' + usernameGuru);
    const snapshotGuru = await get(specificRef);

    if (snapshotGuru.exists()) {
        // Data ditemukan, lakukan sesuatu dengan snapshotGuru.val()
        const user = snapshotGuru.val();

        if (!anggota_kelompok[groupUser]) { 
            anggota_kelompok[groupUser] = {};
        }
        if (!anggota_kelompok[groupUser][usernameGuru]) { 
            anggota_kelompok[groupUser][usernameGuru] = {};
        }

        anggota_kelompok[groupUser][usernameGuru] = {
            nama : user.name,
            konfirmasi : true,
            guru : true,
          };
    } else {
        // Data tidak ditemukan
        console.log("Data Guru tidak ditemukan.");
    }
} catch (error) {
    // Tangani kesalahan jika ada
    console.error("Error:", error);
}
});


function tambahAnggotaGroupBadge(kelompok){
  
    let anggotKelompokChat = document.getElementById("anggota-kelompok-chat");
    anggotKelompokChat.innerHTML = "";
    $('#namaKelompokRoomChat').text("Kelompok " + kelompok)
    // Mendapatkan array dari semua keys (nama properti) dalam objek
    const keys = Object.keys(anggota_kelompok[kelompok]);

    // Iterasi melalui array keys dan akses nilai dari setiap properti
    keys.forEach(key => {
      const user = anggota_kelompok[kelompok][key];

       // Membuat elemen span baru
       var newSpan = document.createElement("span");
       let badgeColor = "";
       let nama = ""
       if(user.guru){
        badgeColor = "warning";
        nama = "Gr. " + user.nama;
       } else {
        badgeColor = (user.konfirmasi == true)? "success" : "danger";
        nama = user.nama===nm? "Anda" : user.nama;
       }
       newSpan.className = `me-1 badge text-bg-${badgeColor}`; // Menetapkan kelas CSS

       // Membuat teks yang akan ditampilkan di dalam span
       var newText = document.createTextNode(`${nama}`);

       // Menambahkan teks ke dalam elemen span
       newSpan.appendChild(newText);

       // Menambahkan elemen span ke dalam elemen anggotKelompokChat
       anggotKelompokChat.appendChild(newSpan);
    });

     
  }


let chatPopup = document.getElementById('chatPopup');

console.log(anggota_kelompok[groupUser])
    

    let closeChat = document.getElementById('closeChat')
    closeChat.addEventListener('click', function(){
      chatPopup.style.display = 'none';
      floatingBtn.style.display = 'block';
    })


    function createBubbleMsg(sender, message, time){
          var bubble = document.createElement('div');
          bubble.textContent = message;
    
          if (sender === nisnUser) {
            var bubbleClass = 'bubble-me';
            bubble.style.float = 'right';
            bubble.style.backgroundColor = '#AAD8D3';
            bubble.style.paddingTop = '10px'; 
            bubble.style.paddingRight = '10px'; 
            bubble.style.minWidth = '50px';
            
          } else {
            bubble.style.float = 'left';
            bubble.style.backgroundColor = '#2F323A';
            bubble.style.paddingTop = '30px'; 
            let namaSender = anggota_kelompok[groupUser][sender].nama;

                if(anggota_kelompok[groupUser][sender].guru){
                    bubble.style.backgroundColor = '#FFC107';
                    
                    namaSender = "Guru " + anggota_kelompok[groupUser][sender].nama;
                }
            
            var senderSpan = document.createElement('span');
                senderSpan.textContent = namaSender;
            
            senderSpan.style.fontSize = '0.8em';
            senderSpan.style.position = 'absolute';
            senderSpan.style.top = '10px'; 
            senderSpan.style.left = '10px'; 
            senderSpan.style.paddingRight = '20px'; 
            senderSpan.style.fontWeight = 'bold';
            

            bubble.appendChild(senderSpan);

            bubble.style.minWidth = (namaSender.length * 1 > message.length * 1)? namaSender.length * 1 + 'em' : message.length * 1 + 'em'; // Mengatur lebar minimum bubble
          }
    
          bubble.style.color = '#fff';
          bubble.style.borderRadius = '10px';
          bubble.style.maxWidth = '80%';
          bubble.style.marginBottom = '10px';
          bubble.style.clear = 'both';
          bubble.style.overflow = 'hidden';
          bubble.style.paddingLeft = '10px'; 
          bubble.style.paddingBottom = '20px'; 
          bubble.style.wordWrap = 'break-word';
          bubble.style.position = 'relative'; // Container bubble chat harus dalam posisi relatif

    
          var timeSpan = document.createElement('span');
          timeSpan.textContent = time;
          timeSpan.style.fontSize = '0.6em';
          timeSpan.style.position = 'absolute';
          timeSpan.style.bottom = '5px'; 
          timeSpan.style.right = '5px'; 
          timeSpan.style.padding = '0 5px'; // Padding kiri-kanan minimum untuk span waktu
    
          
    
          // Tambahkan timeSpan ke dalam bubble
          bubble.appendChild(timeSpan);
          
          var chatMessages = document.getElementById('chatMessages');
          chatMessages.appendChild(bubble);
    }

    function getTimeStamp(){
        // Mendapatkan tanggal dan waktu saat ini
        const currentDateTime = new Date();

        // Mendapatkan tahun
        const year = currentDateTime.getFullYear();

        // Mendapatkan bulan (dalam format dua digit)
        const month = String(currentDateTime.getMonth() + 1).padStart(2, '0');

        // Mendapatkan tanggal (dalam format dua digit)
        const date = String(currentDateTime.getDate()).padStart(2, '0');

        // Mendapatkan jam (dalam format dua digit)
        const hours = String(currentDateTime.getHours()).padStart(2, '0');

        // Mendapatkan menit (dalam format dua digit)
        const minutes = String(currentDateTime.getMinutes()).padStart(2, '0');

        // Mendapatkan detik (dalam format dua digit)
        const seconds = String(currentDateTime.getSeconds()).padStart(2, '0');

        // Mendapatkan milidetik (dalam format tiga digit)
        const milliseconds = String(currentDateTime.getMilliseconds()).padStart(3, '0');

        // Gabungkan semua komponen untuk membuat timestamp dalam format yang diinginkan
        const timestamp = `${year}${month}${date}${hours}${minutes}${seconds}${milliseconds}`;

        return timestamp
    }
    
    let sendButton = document.getElementById('sendButton')
    sendButton.addEventListener('click', function(){ 
        sendMessage();
    });

    function sendMessage() {
        const message = document.getElementById('messageInput').value.trim();
        const currentTime = new Date();
        const options = { hour: '2-digit', minute: '2-digit', hour12: false };
        const formatter = new Intl.DateTimeFormat('id', options);
        const formattedTime = formatter.format(currentTime);
    
        if (message !== '') {
         const chatMessages = document.getElementById('chatMessages');

          set(ref(db, 'dataKelompok/'+ groupUser + '/chatGroup/'+getTimeStamp()), {
            usnPengirim : nisnUser,
            pesan : message,
            pada  : formattedTime
          });

        // Auto-scroll ke paling bawah saat ada chat baru
        chatMessages.scrollTop = chatMessages.scrollHeight;
    
        // Kosongkan input teks setelah mengirim
        document.getElementById('messageInput').value = '';
    
        }
    }

    
    

    floatingBtn.addEventListener('click', function () {
        document.getElementById('chatPopup').style.display = 'block';
        document.getElementById('floatingButton').style.display = 'none';
        scrollToBottom();
        tambahAnggotaGroupBadge(groupUser);
        sortirBadgeAnggotaKelompok();
        loadMessages();
    });

    function createTooltip(item, pesan){
        item.addEventListener('mouseover', function() {
            // Buat elemen tooltip
            const tooltip = document.createElement('div');
            tooltip.textContent = pesan;
        
           // Gaya untuk tooltip
            tooltip.style.position = 'absolute';
            tooltip.style.background = '#333';
            tooltip.style.color = '#fff';
            tooltip.style.padding = '5px';
            tooltip.style.borderRadius = '5px';
            tooltip.style.right = '20px'; // Letakkan di samping kiri tombol
            tooltip.style.bottom = '-290px'; // Letakkan di atas tombol
                    
            // Menambahkan tooltip ke dalam dokumen
            document.body.appendChild(tooltip);
        
            // Menghapus tooltip setelah beberapa detik (opsional)
            setTimeout(function() {
                tooltip.parentNode.removeChild(tooltip);
            }, 2000);
        });
    }
    


    document.getElementById('chatMessages').addEventListener('scroll', function() {
        var floatingButtonDown = document.getElementById('floatingButtonDown');
    
        // Jika posisi scroll tidak berada di bagian paling bawah
        if (this.scrollTop < (this.scrollHeight - this.clientHeight)) {
            // Munculkan floating button down
            if (!floatingButtonDown) {
                floatingButtonDown = document.createElement('button');
                floatingButtonDown.id = 'floatingButtonDown';
                floatingButtonDown.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#2F323A" class="bi bi-arrow-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1"/>
                </svg>`;
                floatingButtonDown.style.position = 'absolute';
                floatingButtonDown.style.bottom = '80px'; 
                floatingButtonDown.style.right = '40px';
                floatingButtonDown.style.width = '40px'; 
                floatingButtonDown.style.height = '40px'; 
                floatingButtonDown.style.borderRadius = '50%';
                floatingButtonDown.style.border = '2px solid #2F323A'; 
                floatingButtonDown.style.backgroundColor = '#fff'; 
                floatingButtonDown.style.cursor = 'pointer';
                floatingButtonDown.onclick = function() {
                    var chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                };
    
                document.getElementById('chatPopup').appendChild(floatingButtonDown);
            }
        } else {
            // Sembunyikan floating button down jika posisi scroll berada di bagian paling bawah
            if (floatingButtonDown) {
                floatingButtonDown.parentNode.removeChild(floatingButtonDown);
            }
        }
    });

// Variabel untuk menyimpan referensi event listener saat ini
let currentListener = null;

function loadMessages() {
    const groupChatRef = ref(db, 'dataKelompok/' + groupUser + '/chatGroup/');
    const que = query(groupChatRef, orderByKey());

    // Hapus event listener sebelumnya jika ada
    if (currentListener) {
        currentListener(); // Panggil event listener untuk menghapusnya
    }

    let prevKey = "";

    // Tambahkan event listener baru untuk kelompok saat ini
    currentListener = onChildAdded(que, (snapshot) => {
        const chatData = snapshot.val();
        if(prevKey == ""){
            showSeparatorWithDate(snapshot.key)
        } else {
            let isCreateSeparator = compareDates(prevKey, snapshot.key);
            (isCreateSeparator)? showSeparatorWithDate(snapshot.key) : "";
        }
        prevKey = snapshot.key;
        createBubbleMsg(chatData.usnPengirim, chatData.pesan, chatData.pada);
        scrollToBottom();
});
}

function scrollToBottom(){
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function sortirBadgeAnggotaKelompok(){
        var spans = document.querySelectorAll("#anggota-kelompok-chat span");

        // Membuat array dari nodeList
        var spansArray = [];

       // Memasukkan elemen-elemen <span> ke dalam array sementara dan melakukan penggantian nama jika terdiri dari dua kata atau lebih
        spans.forEach(function(span) {
            var text = span.textContent.trim();
            var name = extractName(text);
            if (name.includes(' ')) {
                name = name.split(' ')[1];
            }
            span.textContent = name;
            spansArray.push({ element: span, name: name });
        });

        // Fungsi untuk mengekstrak nama dari teks dan mengembalikan kata kedua jika ada
        function extractName(text) {
            var words = text.split(' ');
            if (words.length > 1) {
                return words[1];
            }
            return text;
        }

        // Mengurutkan elemen-elemen <span> yang tersisa berdasarkan teks yang ada di dalamnya
        spansArray.sort(function(a, b) {
            var textA = a.name.toLowerCase();
            var textB = b.name.toLowerCase();
            return textA.localeCompare(textB);
        });

        // Mencari index elemen <span> yang berisi teks "Anda"
        var indexAnda = -1;
        spansArray.forEach(function(span, index) {
            var spanText = span.name.trim();
            if (spanText === "Anda") {
                indexAnda = index;
            }
        });

        // Jika elemen <span> yang berisi teks "Anda" ditemukan
        if (indexAnda !== -1) {
            // Memindahkan elemen <span> yang berisi teks "Anda" ke urutan pertama
            var spanAnda = spansArray.splice(indexAnda, 1)[0];
            spansArray.unshift(spanAnda);
        }

        // Mendapatkan parent dari elemen <span>
        var parentElement = document.getElementById("anggota-kelompok-chat");

        // Menghapus semua elemen <span> dari parent
        parentElement.innerHTML = "";

        spansArray.forEach(function(span) {
            parentElement.appendChild(span.element);
        });
   
}

// Fungsi untuk mengonversi timestamp ke format Date
function convertTimestampToDateTime(timestampString) {
    const year = timestampString.slice(0, 4);
    const month = timestampString.slice(4, 6) - 1; // Bulan dimulai dari 0 (Januari)
    const day = timestampString.slice(6, 8);
    const hour = timestampString.slice(8, 10);
    const minute = timestampString.slice(10, 12);
    const second = timestampString.slice(12, 14);
    const millisecond = timestampString.slice(14);

    return new Date(year, month, day, hour, minute, second, millisecond);
}

// Fungsi untuk menampilkan pemisah dengan keterangan hari dan tanggal dari timestamp dalam format `yyyymmddhhmmmsmsm`
function showSeparatorWithDate(timestampString) {
    const timestamp = convertTimestampToDateTime(timestampString); // Mengonversi timestamp ke format Date
    const currentDate = new Date(); // Timestamp hari ini

    const separator = document.createElement('hr'); // Membuat elemen garis pembatas
    separator.style.border = 'none'; // Menghilangkan border dari garis pembatas
    separator.style.borderTop = '2px solid #ccc'; // Menambahkan border di bagian atas garis pembatas
    separator.style.margin = '10px 0'; 
    separator.style.marginBottom = '10px';
    separator.style.clear = 'both';
    separator.style.overflow = 'hidden';
    separator.style.position = 'relative'; 

    // Membuat elemen untuk menampilkan keterangan hari dan tanggal
    const dateInfo = document.createElement('div');
    let today = currentDate.getDate();
    let dayFromTimestamp = timestamp.getDate();

    if (today == dayFromTimestamp) {
        // Jika timestamp hari ini
        dateInfo.textContent = 'Hari ini';
    } 
    else if (today - dayFromTimestamp == 1) {
        // Jika timestamp kemarin
        dateInfo.textContent = 'Kemarin';
    } else if (today - dayFromTimestamp <= 7 ) {
        // Jika masih dalam minggu yang sama dengan hari ini
        const options = { weekday: 'long' };
        dateInfo.textContent = timestamp.toLocaleDateString('id-ID', options);
    } else {
        // Jika berbeda minggu dengan hari ini
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateInfo.textContent = timestamp.toLocaleDateString('id-ID', options);
    }

    dateInfo.style.textAlign = 'center'; // Pusatkan teks

    // Menambahkan elemen keterangan hari dan tanggal ke dalam elemen garis pembatas
    separator.appendChild(dateInfo);

    // Menambahkan garis pembatas beserta keterangan hari dan tanggal ke dalam body
    let chatMessages = document.getElementById("chatMessages")
    chatMessages.appendChild(separator);
}

// Fungsi untuk membandingkan dua tanggal berdasarkan
function compareDates(timestampString1, timestampString2) {
    // Mengambil bagian `yyyymmdd` dari string timestamp
    const date1 = timestampString1.slice(0, 8);
    const date2 = timestampString2.slice(0, 8);

    if (date1 === date2) {
        return 0; // Jika tanggal sama
    } else if (date1 < date2) {
        return 1; // Jika tanggal pertama lebih kecil dari tanggal kedua
    } 
}
  //===============================================================================================================================

/*
    import {getStorage, ref as refStorage, uploadBytesResumable, getDownloadURL} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

   // Initialize Firebase
    const storage = getStorage(app);

    // Upload file function
    let uploadBtn = document.getElementById('uploadButton')
    uploadBtn.addEventListener('click', ()=>{
        const file = document.getElementById('pdfFile').files[0];
        const storageRef = refStorage(storage, 'fileSiswa/' + nisnUser + '/' + file.name);
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on('state_changed',
            (snapshot) => {
                const percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                document.getElementById('progressBar').style.display = 'block';
                document.querySelector('.progress-bar').style.width = percentage + '%';
            },
            (error) => {
                console.error('Upload error:', error);
            },
            () => {
                uploadBtn.disabled = true;
                console.log('Upload complete');
                document.getElementById('progressBar').style.display = 'none';
                getDownloadURL(storageRef)
                .then((url) => {
                    saveDownloadURL(file.name, url);
                    alert('Upload completed successfully!');
                })
                .catch((error) => {
                    console.error('Error getting download URL:', error);
                });
                
            }
        );
    });

 // Function to save download URL to Firebase Realtime Database
    function saveDownloadURL(namaFile, downloadURL) {
      //  const database = getDatabase(app);
        const downloadURLRef = ref(db, 'dataSiswa/' + nisnUser + '/kerja_kelompok/materi1/files/');
        
        set(downloadURLRef, {
            nama_file: namaFile,
            url: downloadURL,
        })
        .then(() => {
            console.log('Download URL saved to Firebase Realtime Database');
        })
        .catch((error) => {
            console.error('Error saving download URL to Firebase Realtime Database:', error);
        });
    }


// ================================ PRINT HANDLER =============================
let cetakBtn = document.getElementById("cetakBtn")

cetakBtn.addEventListener('click', () => {
   // printArea('area');
    
    window.print();
});

*/
// ================================= GET SESSION 
    let nama = document.getElementById('nama');
    
    nama.innerHTML = `<i class="fa-solid fa-user"></i> ${nm}`;

    
    </script>
</html>