<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPLH</title>
    <link rel="stylesheet" href="../css/stylekikd.css">
    <link rel="stylesheet" href="../fontawesome/fontawesome/css/all.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- ADDITIONAL JQUERY -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" charset="UTF-8"></script>
    <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-chtml.min.js"></script>
</head>

<style>
    td.upper_line { border-top:solid 1px black; }
    table.fraction { text-align: center; vertical-align: middle;
        margin-top:0.5em; margin-bottom:0.5em; line-height: 2em; }
    
    img{
        border: 1px solid #000000;
        margin: 10px;
    }

    .accordion {
  background-color: #eee;
  color: #444;
  cursor: pointer;
  padding: 18px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 15px;
  transition: 0.4s;
}

.active, .accordion:hover {
  background-color: #ccc;
}

.panel {
  padding: 0 18px;
  background-color: white;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.2s ease-out;
}

.floating-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000; /* untuk memastikan tombol muncul di atas konten lain */
  }

</style>

<body>
    <!-- HEADER AREA START-->
    <input type="checkbox" id="check">
    <header>
        <label for="check">
            <i class="fas fa-bars" id="sidebar_btn"></i>
        </label>
        <div class="left_area">
            <h3>PPLH</h3>
        </div>
        <div class="right_area">
            <a href="../index.html" class="logout_btn">
                <i class="fas fa-home"></i>
            </a>

            <h5 class="logout_btn" id="nama"></h5>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="myBar"></div>
        </div> 
    </header>
    <!-- HEADER AREA END tulis tahap-->

    <!-- SIDEBAR START -->
    <nav class="sidebar">
        <div class="profile_info">
            <h3>Materi</h3>
            <hr style="width: 90%; color: #fff; margin: 5px 0 5px 0;">
        </div>
        <ul>
            <li><a href="1.Pengantar.html" class="menu-btn"><span class="numbering"></span><span class="numbering_text">Pendahuluan</span> </a></li>
            <li id="active"><a href="1Keseimbangan.html" class="menu-btn"><span class="numbering">1.</span><span class="numbering_text">Keseimbangan dan Perubahan Lingkungan Hidup<i class="fas fa-caret-down"></i></span></a></li>
            <ul class="menu-show">
                <li><a href="Kuis1_PilihanGanda.html"><span class="numbering_text">Kuis 1</span></a></li>
            </ul>
            <li><a href="2.1udara.html" class="menu-btn"><span class="numbering">2.</span><span class="numbering_text">Pencemaran Lingkungan Hidup<i class="fas fa-caret-down"></i></span></a>
                <ul class="menu-show"> 
                    <li><a href="2.1udara.html"><span class="numbering_text">2.1 Pencemaran Udara</span></a></li>
                    <li><a href="2.2Air.html"><span class="numbering_text">2.2 Pencemaran Air</span></a></li>
                    <li><a href="2.3tanah.html"><span class="numbering_text">2.3 Pencemaran Tanah</span></a></li>
                    <li><a href="2.4suara.html"><span class="numbering_text">2.4 Pencemaran Suara</span></a></li>
                    <li><a href="Kuis2_PilihanGanda.html"><span class="numbering_text">Kuis 2</span></a></li>
                 </ul>
            </li>
            <li><a href="3akumulasi.html" class="menu-btn"><span class="numbering">3.</span><span class="numbering_text">Akumulasi Bahan Pencemar dalam Rantai Makanan<i class="fas fa-caret-down"></i></span></a>
                <ul class="menu-show">
                    <li><a href="Kuis3_PilihanGanda.html"><span class="numbering_text">Kuis 3</span></a></li>
                </ul>
            <li><a href="#" class="menu-btn"><span class="numbering">4.</span><span class="numbering_text">Penanganan Limbah<i class="fas fa-caret-down"></i></span></a>
                <ul class="menu-show">
                    <li><a href="4.1cair.html"><span class="numbering">4.1</span><span class="numbering_text">Penanganan Limbah Cair</span></a></li>
                    <li><a href="4.2padat.html"><span class="numbering">4.2</span><span class="numbering_text">Penanganan Limbah Padat</span></a></li>
                    <li><a href="4.3gas.html"><span class="numbering">4.3</span><span class="numbering_text">Penanganan Limbah Gas</span></a></li>
                    <li><a href="4.4b3.html"><span class="numbering">4.4</span><span class="numbering_text">Penanganan Limbah Bahan Berbahaya dan Beracun (B3)</span></a></li>
                 </ul>
            <li><a href="#" class="menu-btn"><span class="numbering">5.</span><span class="numbering_text">Dinamika Komunitas, Adaptasi dan Mitigasi terhadap Perubahan Lingkungan<i class="fas fa-caret-down"></i></span></a>
                <ul class="menu-show">
                    <li><a href="5dinamika.html"><span class="numbering">5.1</span><span class="numbering_text">Dinamika Komunitas</span></a></li>
                    <li><a href="5.2adaptasi.html"><span class="numbering">5.2</span><span class="numbering_text">Adaptasi dan Mitigasi terhadap Perubahan Lingkungan</span></a></li>
                </ul>
            <li><a href="#" class="menu-btn"><span class="numbering"></span><span class="numbering_text">Evaluasi</span></a> </li>
        </ul>
    </nav>
    <!-- SIDEBAR END -->

    <!-- CONTENT AREA START-->
    <div class="content">
        <div class="card-header-bab"><center>1. Keseimbangan dan Perubahan Lingkungan Hidup</center></div>
        <div class="card-header-2" id="menu-btn1" >Langkah 1: Tujuan dan Motivasi <i class="fas fa-caret-down"></i></div>
        <div class= "content-card" id="menu-show1">
            <p>Tujuan yang ingin dicapai dalam pembelajaran ini, yaitu:</p>
            <ul>
                <li> Peserta didik dapat menganalisis dan mengemukakan gagasan terkait pemecahan masalah perubahan lingkungan di daerahnya.</li>
            </ul>
            <br>
            <b><center>Ayo Tonton Video di bawah ini!</center></b>
            <div style="text-align: center">
                <video width="420" controls>
                    <source src="images/Video 2. Pengantar Keseimbangan.mp4" type="video/mp4">
                </video>
                  <p>Video 2. Pengantar Keseimbangan dan Perubahan Lingkungan Hidup</p>
                </div>
        </div>
        <br>

        <div class="card-header-2" id="menu-btn2">Langkah 2: Informasi <i class="fas fa-caret-down"></i></div>
        <div class="content-card" id="menu-show2">
            <p>Pembelajaran ini menggunakan metode Cooperative Learning. Adapun cara kerjanya:
                <ul>
                    <li>Peserta didik mencari kelompok dan namanya pada tahap "Temukan Teman".</li>
                    <li>Peserta didik belajar bersama teman kelompok.</li>
                    <li>Peserta didik dapat melakukan diskusi pada kolom chat.</li>
                    <li>Peserta didik mengerjakan soal latihan secara berkelompok.</li>
                    <li>Kelompok yang mempunyai jumlah nilai terbanyak maka akan diberi penghargaan.</li>
                </ul>
            </p>
        </div>
        <br>
        
        <div class="card-header-2" id="menu-btn3">Langkah 3: Temukan Teman <i class="fas fa-caret-down"></i></div>
        <div class="content-card" id="menu-show3">
            <p>Temukan nama dan kelompok belajarmu dengan cara pilih kemudian konfirmasi dengan tekan tombol kirim.</p>
                <table class="table" style="width:100%">
                    <tr>
                    <th>No.</th>
                    <th>Kelompok</th>
                    <th>Nama Anggota</th>
                    <th>Konfirmasi</th>
                    </tr>
                    <tbody id="tbody1"></tbody>

                    <!-- <tr id="satu">
                    <td>1.</td>
                    <td><input type="radio" id="kelompok" name="namakelompok"><label for="namakelompok"> Kelompok A</label></td>
                    <td><input type="radio" id="anggotakelompok" name="namaanggota"><label for="namaanggota"> nama1</label><br>
                        <input type="radio" id="anggotakelompok" name="namaanggota"><label for="namaanggota"> nama2</label></td>
                    <td><center><button class="button-utama" id="konfirmasiya">Ya</button>
                    <button class="button-utama" id="konfirmasitidak">Tidak</button></center></td>
                        <p id="jawaban"></p>
                    </td>
                    </tr>

                    <tr id="dua"> -->
                    <!-- <td>2.</td>
                    <td><input type="radio" id="kelompok" name="namakelompok"><label for="namakelompok"> Kelompok B</label></td>
                    <td><input type="radio" id="anggotakelompok" name="namaanggota"><label for="namaanggota"> nama1</label><br>
                        <input type="radio" id="anggotakelompok" name="namaanggota"><label for="namaanggota"> nama2</label></td>
                    <td><center><button class="button-utama" id="konfirmasiya">Ya</button>
                        <button class="button-utama" id="konfirmasitidak">Tidak</button></center></td> -->
                   </tr>
                   
                   </table>
                   <br>
                  <!-- <center><button class="button-utama" id="kirim1"><p>Kirim</p></button></center> -->
                   <br>
        </div>
        <br> 

        <div class="footer-nav">
            <a href="#" class="footer-number">Sebelumnya</a>
            <a href="#" class="footer-number">1</a>
            <a href="#" class="footer-number">2</a>
            <a href="#" class="footer-number">3</a>
            <a href="1Keseimbanganmateri.html" class="footer-number">Selanjutnya</a>
        </div>

        <style>
            .floating-button {
              position: fixed;
              bottom: 20px;
              right: 20px;
              z-index: 1000; /* untuk memastikan tombol muncul di atas konten lain */
            }
        
            .chat-room {
                z-index: 1000;
              width: 400px;
              height: 500px;
              position: fixed;
              bottom: 20px;
              right: 20px;
              background-color: #fff;
              border: 1px solid #424242;
              border-radius: 5px;
            }
        
            .chat-header {
              background-color: #AAD8D3;
              color: #fff;
              padding: 10px;
              border-top-left-radius: 5px;
              border-top-right-radius: 5px;
            }
        
            .chat-body {
              overflow-y: auto;
              padding: 10px;
              height: calc(100% - 140px);
            }
        
            .chat-footer {
                margin-bottom: 0;
              padding: 10px;
              border-top: 1px solid #ccc;
              display: flex; /* Mengatur elemen dalam satu baris */
              align-items: center; /* Menyelaraskan elemen secara vertikal */
            }
        
            .bubble {
              max-width: 70%;
              margin-bottom: 10px;
              clear: both;
              overflow: hidden;
              padding: 10px;
              border-radius: 10px;
              word-wrap: break-word;
            }
        
            .bubble.me {
              float: right;
              background-color: #007bff;
              color: #fff;
            }
        
            .bubble.other {
              float: left;
              background-color: #28a745;
              color: #fff;
            }
        
            .chat-time {
              font-size: 0.8em;
              float: right;
            }
            .close-btn {
                margin-top: -30px;
                float: right;
            }

            /* Style untuk elemen input teks */
            #messageInput {
                width: calc(100% - 60px); 
                border: 2px solid #AAD8D3; 
                border-radius: 5px; 
                margin-right: 10px; 
                box-sizing: border-box; 
            }

            /* Style untuk tombol kirim */
            #sendButton {
                width: 40px; 
                height: 40px; 
                background-color: #AAD8D3; 
                border: none; 
                border-radius: 100%; 
                color: #fff;
                font-size: 1.2em; 
                cursor: pointer;
            }
            #sendButton:hover{
                background-color: #2F323A; 
            }
          </style>
             <!-- Floating Button -->
  <!-- Floating Button -->
  <button id="floatingButton" class="btn btn-primary floating-button">Chat</button>

  <!-- Popup untuk room chat -->
  <div id="chatPopup" class="chat-room" style="display: none;">
    <div class="chat-header">
      <h4 class="mt-2 ms-2" id="namaKelompokRoomChat">Nama Kelompok</h4>
        <button type="button" class="btn-close close-btn" id="closeChat" aria-label="Close"></button>
        <div class="ms-2" id="anggota-kelompok-chat">
            
        </div>
    </div>
    <div class="chat-body" id="chatMessages"></div>
    <div class="chat-footer">
      <input type="text" class="form-control" id="messageInput" placeholder="Ketik pesan...">
      <button type="button" class="btn btn-block" id="sendButton""><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
      </svg></button>
    </div>
  </div>

    </div>
    <!--CONTENT AREA END -->
    
    <!-- JAVASCRIPT AREA START-->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
    <script type="module">
      //---------project setting firebase-----------
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
      
      const firebaseConfig = {
          apiKey: "AIzaSyBAEK9blcK9ZjeIT8kPPWk8_xv7jgwjYQo",
          authDomain: "pplh-70ccb.firebaseapp.com",
          databaseURL: "https://pplh-70ccb-default-rtdb.firebaseio.com",
          projectId: "pplh-70ccb",
          storageBucket: "pplh-70ccb.appspot.com",
          messagingSenderId: "823611849079",
          appId: "1:823611849079:web:a0f8c81197a46a2e1dc972"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);

      import { getDatabase, ref, child, onValue, get, set, query, remove, orderByChild, onChildAdded, equalTo, update, orderByKey, limitToLast } 
      from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
      
      const db = getDatabase();
    var acc = document.getElementsByClassName("accordion");
    var i;

   
    for (i = 0; i < acc.length; i++) {
    acc[i].addEventListener("click", function() {
        this.classList.toggle("active");
        var panel = this.nextElementSibling;
        if (panel.style.maxHeight) {
        panel.style.maxHeight = null;
        } else {
        panel.style.maxHeight = panel.scrollHeight + "px";
        } 
    });
    }

    let isConfirmUser = "";
    let floatingBtn = document.getElementById('floatingButton');
        
        
    onValue(ref(db, "dataSiswa/" + nisnUser), (snapshot) => {
        let data = snapshot.val();
            isConfirmUser = data.konfirmasi;
            if (isConfirmUser === false ){
                floatingBtn.setAttribute("disabled", "true");
                createTooltip(floatingBtn, "Harap konfirmasi kelompok Terlebih dahulu");
                
            } else if (isConfirmUser === true ){
                floatingBtn.removeAttribute("disabled");
            } else {
                floatingBtn.setAttribute("disabled", "true");
                createTooltip(floatingBtn, "Harapkon login Terlebih dahulu");
            }
    });

    

   
    let tmp = document.querySelector('#tbody1');
    const que = query(ref(db, "dataSiswa/"));
    onValue(que, (snapshot) => {
        let anggotKelompokChat = document.getElementById("anggota-kelompok-chat");
        tmp.innerHTML = "";
        var no = 1;
        const users = snapshot.val();

        // Objek untuk menyimpan data pengguna yang dikelompokkan berdasarkan kelompok
        const groupedUsers = {};

        // Mengelompokkan pengguna berdasarkan kelompok
        Object.values(users).forEach(user => {
            const kelompok = user.kelompok;
            if (!groupedUsers[kelompok]) {
                groupedUsers[kelompok] = [];
            }
            groupedUsers[kelompok].push(user);
        });

        // Mengurutkan kelompok secara alfabetis
        const sortedGroups = Object.keys(groupedUsers).sort();

        // Membuat baris tabel untuk setiap kelompok
        sortedGroups.forEach(kelompok => {
            const usersInGroup = groupedUsers[kelompok];
            let list = "";
            
            let confirmBtn = "";
            usersInGroup.forEach(user => {
                

                if(user.kelompok == groupUser){ 
                    if(!anggota_kelompok[user.kelompok]){ 
                        anggota_kelompok[user.kelompok] = {};
                    };
                    if(!anggota_kelompok[user.kelompok][user.nisn]){ 
                        anggota_kelompok[user.kelompok][user.nisn] = {};
                    };
                    anggota_kelompok[user.kelompok][user.nisn] = {
                      nama : user.nama,
                      konfirmasi : user.konfirmasi,
                      guru : false,
                    };
                };
                list += `<input class="form-check-input ms-2" type="radio" id="anggotakelompok" name="namaanggota" value="${user.nama}" ${user.nisn === nisnUser ? "checked" : "disabled"}>
                        <label class="ms-2" for="namaanggota">${user.nama}</label><br>`;

                if(user.nisn == nisnUser){
                    if(user.konfirmasi){
                        confirmBtn += `<span class="badge text-bg-success" id="terkonfirmasi">Terkonfirmasi</span><br>`;
                    } else {
                        confirmBtn += `<button class="btn btn-success" id="konfirmasiya">Ya</button>
                                    <button class="btn btn-danger" id="konfirmasitidak">Tidak</button><br>`;
                        anggotKelompokChat.innerHTML += '<span class="me-1 badge text-bg-danger">Anda</span>';
                    }
            
                } else {
                    confirmBtn += `<span class="badge ${(user.konfirmasi) ? "text-bg-success" : "text-bg-danger"} m-1" id="status">${(user.konfirmasi) ? " Terkonfirmasi " : " Belum Konfirmasi "}</span><br>`;
                    
                } 
                
            });
        let tr = `
            <tr class="m-1 ms-3">
                <td class="text-center">${no}</td>
                <td class="text-center"><label for="namakelompok">${kelompok}</label></td>
                <td>${list}</td>
                <td class="text-center">
                    ${confirmBtn}
                </td>
            </tr>
        `;
        tmp.innerHTML += tr;
        (isConfirmUser == true)? "" : tambahkanEventListener();
        no++;
    });
});

    function tambahkanEventListener() {
        try {

            // Cari elemen yang ingin Anda tambahkan event listener-nya
            let konfirmasiBtn = document.getElementById("konfirmasiya");

            // Pastikan elemen ditemukan sebelum menambahkan event listener
            if (konfirmasiBtn) {
                    konfirmasiBtn.addEventListener("click", ()=> {
                        const dbRef = ref(db);
                        update(child(dbRef, "dataSiswa/"+ nisnUser),
                        {
                        konfirmasi: true,
                        })
                        .then(()=>{
                            Swal.fire({
                                title: "Selamat!",
                                text: "Konfirmasi Berhasil.",
                                icon: "success",
                                button: "Ok",
                              });
                        })
                        .catch((error)=>{
                            console.error("Error : " + error);
                            Swal.fire({
                                title: "Maaf!",
                                text: "Konfirmasi Gagal.",
                                icon: "error",
                                button: "Lanjutkan",
                              });
                        });
                    });
            } else {
                console.error('Elemen tidak ditemukan');
            }
        } catch (error) {
            console.error('Terjadi kesalahan:', error);
        }
    }

// ================================= CHAT KELOMPOK ========================================

let anggota_kelompok = {}

const queA = query(ref(db, "dataKelompok/" + groupUser));
onValue(queA, async (snapshot) => {
    const usersGroup = snapshot.val();
    const usernameGuru = usersGroup.pengawas;

    try {
        const specificRef = ref(db, 'dataGuru/' + usernameGuru);
        const snapshotGuru = await get(specificRef);

        if (snapshotGuru.exists()) {
            // Data ditemukan, lakukan sesuatu dengan snapshotGuru.val()
            const user = snapshotGuru.val();

            if (!anggota_kelompok[groupUser]) { 
                anggota_kelompok[groupUser] = {};
            }
            if (!anggota_kelompok[groupUser][usernameGuru]) { 
                anggota_kelompok[groupUser][usernameGuru] = {};
            }

            anggota_kelompok[groupUser][usernameGuru] = {
                nama : user.name,
                konfirmasi : true,
                guru : true,
              };
            console.log("Nama Guru:", anggota_kelompok[usersGroup][usernameGuru].nama);
        } else {
            // Data tidak ditemukan
            console.log("Data Guru tidak ditemukan.");
        }
    } catch (error) {
        // Tangani kesalahan jika ada
        console.error("Error:", error);
    }
});


    function tambahAnggotaGroupBadge(kelompok){
      
        let anggotKelompokChat = document.getElementById("anggota-kelompok-chat");
        anggotKelompokChat.innerHTML = "";
        $('#namaKelompokRoomChat').text("Kelompok " + kelompok)
        // Mendapatkan array dari semua keys (nama properti) dalam objek
        const keys = Object.keys(anggota_kelompok[kelompok]);
  
        // Iterasi melalui array keys dan akses nilai dari setiap properti
        keys.forEach(key => {
          const user = anggota_kelompok[kelompok][key];
  
           // Membuat elemen span baru
           var newSpan = document.createElement("span");
           let badgeColor = "";
           let nama = ""
           if(user.guru){
            badgeColor = "warning";
            nama = "Gr. " + user.nama;
           } else {
            badgeColor = (user.konfirmasi == true)? "success" : "danger";
            nama = user.nama===nm? "Anda" : user.nama;
           }
           newSpan.className = `me-1 badge text-bg-${badgeColor}`; // Menetapkan kelas CSS
   
           // Membuat teks yang akan ditampilkan di dalam span
           var newText = document.createTextNode(`${nama}`);
   
           // Menambahkan teks ke dalam elemen span
           newSpan.appendChild(newText);
   
           // Menambahkan elemen span ke dalam elemen anggotKelompokChat
           anggotKelompokChat.appendChild(newSpan);
        });
  
         
      }
    

    let chatPopup = document.getElementById('chatPopup');

    console.log(anggota_kelompok[groupUser])
        

        let closeChat = document.getElementById('closeChat')
        closeChat.addEventListener('click', function(){
          chatPopup.style.display = 'none';
          floatingBtn.style.display = 'block';
        })
    
    
        function createBubbleMsg(sender, message, time){
              var bubble = document.createElement('div');
              bubble.textContent = message;
        
              if (sender === nisnUser) {
                var bubbleClass = 'bubble-me';
                bubble.style.float = 'right';
                bubble.style.backgroundColor = '#AAD8D3';
                bubble.style.paddingTop = '10px'; 
                bubble.style.paddingRight = '10px'; 
                bubble.style.minWidth = '50px';
                
              } else {
                bubble.style.float = 'left';
                bubble.style.backgroundColor = '#2F323A';
                bubble.style.paddingTop = '30px'; 
                let namaSender = anggota_kelompok[groupUser][sender].nama;

                if(anggota_kelompok[groupUser][sender].guru){
                    bubble.style.backgroundColor = '#FFC107';
                    
                    namaSender = "Guru " + anggota_kelompok[groupUser][sender].nama;
                }
                var senderSpan = document.createElement('span');
                senderSpan.textContent = namaSender;
                senderSpan.style.fontSize = '0.8em';
                senderSpan.style.position = 'absolute';
                senderSpan.style.top = '10px'; 
                senderSpan.style.left = '10px'; 
                senderSpan.style.paddingRight = '20px'; 
                senderSpan.style.fontWeight = 'bold';
                
    
                bubble.appendChild(senderSpan);

                bubble.style.minWidth = namaSender.length * 0.8 + 'em'; // Mengatur lebar minimum bubble
              }
        
              bubble.style.color = '#fff';
              bubble.style.borderRadius = '10px';
              bubble.style.maxWidth = '80%';
              bubble.style.marginBottom = '10px';
              bubble.style.clear = 'both';
              bubble.style.overflow = 'hidden';
              bubble.style.paddingLeft = '10px'; 
              bubble.style.paddingBottom = '20px'; 
              bubble.style.wordWrap = 'break-word';
              bubble.style.position = 'relative'; // Container bubble chat harus dalam posisi relatif

        
              var timeSpan = document.createElement('span');
              timeSpan.textContent = time;
              timeSpan.style.fontSize = '0.6em';
              timeSpan.style.position = 'absolute';
              timeSpan.style.bottom = '5px'; 
              timeSpan.style.right = '5px'; 
              timeSpan.style.padding = '0 5px'; // Padding kiri-kanan minimum untuk span waktu
        
              
        
              // Tambahkan timeSpan ke dalam bubble
              bubble.appendChild(timeSpan);
              
              var chatMessages = document.getElementById('chatMessages');
              chatMessages.appendChild(bubble);
        }
    
        function getTimeStamp(){
            // Mendapatkan tanggal dan waktu saat ini
            const currentDateTime = new Date();
    
            // Mendapatkan tahun
            const year = currentDateTime.getFullYear();
    
            // Mendapatkan bulan (dalam format dua digit)
            const month = String(currentDateTime.getMonth() + 1).padStart(2, '0');
    
            // Mendapatkan tanggal (dalam format dua digit)
            const date = String(currentDateTime.getDate()).padStart(2, '0');
    
            // Mendapatkan jam (dalam format dua digit)
            const hours = String(currentDateTime.getHours()).padStart(2, '0');
    
            // Mendapatkan menit (dalam format dua digit)
            const minutes = String(currentDateTime.getMinutes()).padStart(2, '0');
    
            // Mendapatkan detik (dalam format dua digit)
            const seconds = String(currentDateTime.getSeconds()).padStart(2, '0');
    
            // Mendapatkan milidetik (dalam format tiga digit)
            const milliseconds = String(currentDateTime.getMilliseconds()).padStart(3, '0');
    
            // Gabungkan semua komponen untuk membuat timestamp dalam format yang diinginkan
            const timestamp = `${year}${month}${date}${hours}${minutes}${seconds}${milliseconds}`;
    
            return timestamp
        }
        
        let sendButton = document.getElementById('sendButton')
        sendButton.addEventListener('click', function(){ 
            sendMessage();
        });

        function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            const currentTime = new Date();
            const options = { hour: '2-digit', minute: '2-digit', hour12: false };
            const formatter = new Intl.DateTimeFormat('id', options);
            const formattedTime = formatter.format(currentTime);
        
            if (message !== '') {
             const chatMessages = document.getElementById('chatMessages');
    
              set(ref(db, 'dataKelompok/'+ groupUser + '/chatGroup/'+getTimeStamp()), {
                usnPengirim : nisnUser,
                pesan : message,
                pada  : formattedTime
              });
    
            // Auto-scroll ke paling bawah saat ada chat baru
            chatMessages.scrollTop = chatMessages.scrollHeight;
        
            // Kosongkan input teks setelah mengirim
            document.getElementById('messageInput').value = '';
        
            }
        }

        
        
    
        floatingBtn.addEventListener('click', function () {
            document.getElementById('chatPopup').style.display = 'block';
            document.getElementById('floatingButton').style.display = 'none';
            scrollToBottom();
            tambahAnggotaGroupBadge(groupUser);
            sortirBadgeAnggotaKelompok();
            loadMessages();
        });

        function createTooltip(item, pesan){
            item.addEventListener('mouseover', function() {
                // Buat elemen tooltip
                const tooltip = document.createElement('div');
                tooltip.textContent = pesan;
            
               // Gaya untuk tooltip
                tooltip.style.position = 'absolute';
                tooltip.style.background = '#333';
                tooltip.style.color = '#fff';
                tooltip.style.padding = '5px';
                tooltip.style.borderRadius = '5px';
                tooltip.style.right = '20px'; // Letakkan di samping kiri tombol
                tooltip.style.bottom = '-290px'; // Letakkan di atas tombol
                        
                // Menambahkan tooltip ke dalam dokumen
                document.body.appendChild(tooltip);
            
                // Menghapus tooltip setelah beberapa detik (opsional)
                setTimeout(function() {
                    tooltip.parentNode.removeChild(tooltip);
                }, 2000);
            });
        }
        


        document.getElementById('chatMessages').addEventListener('scroll', function() {
            var floatingButtonDown = document.getElementById('floatingButtonDown');
        
            // Jika posisi scroll tidak berada di bagian paling bawah
            if (this.scrollTop < (this.scrollHeight - this.clientHeight)) {
                // Munculkan floating button down
                if (!floatingButtonDown) {
                    floatingButtonDown = document.createElement('button');
                    floatingButtonDown.id = 'floatingButtonDown';
                    floatingButtonDown.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#2F323A" class="bi bi-arrow-down" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1"/>
                    </svg>`;
                    floatingButtonDown.style.position = 'absolute';
                    floatingButtonDown.style.bottom = '80px'; 
                    floatingButtonDown.style.right = '40px';
                    floatingButtonDown.style.width = '40px'; 
                    floatingButtonDown.style.height = '40px'; 
                    floatingButtonDown.style.borderRadius = '50%';
                    floatingButtonDown.style.border = '2px solid #2F323A'; 
                    floatingButtonDown.style.backgroundColor = '#fff'; 
                    floatingButtonDown.style.cursor = 'pointer';
                    floatingButtonDown.onclick = function() {
                        var chatMessages = document.getElementById('chatMessages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    };
        
                    document.getElementById('chatPopup').appendChild(floatingButtonDown);
                }
            } else {
                // Sembunyikan floating button down jika posisi scroll berada di bagian paling bawah
                if (floatingButtonDown) {
                    floatingButtonDown.parentNode.removeChild(floatingButtonDown);
                }
            }
        });

// Variabel untuk menyimpan referensi event listener saat ini
let currentListener = null;

function loadMessages() {
    const groupChatRef = ref(db, 'dataKelompok/' + groupUser + '/chatGroup/');
    const que = query(groupChatRef, orderByKey());

    // Hapus event listener sebelumnya jika ada
    if (currentListener) {
        currentListener(); // Panggil event listener untuk menghapusnya
    }

    // Tambahkan event listener baru untuk kelompok saat ini
    currentListener = onChildAdded(que, (snapshot) => {
        const chatData = snapshot.val();
        createBubbleMsg(chatData.usnPengirim, chatData.pesan, chatData.pada);
        scrollToBottom();
    });
}

function scrollToBottom(){
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

    function sortirBadgeAnggotaKelompok(){
            var spans = document.querySelectorAll("#anggota-kelompok-chat span");
    
            // Membuat array dari nodeList
            var spansArray = [];
    
           // Memasukkan elemen-elemen <span> ke dalam array sementara dan melakukan penggantian nama jika terdiri dari dua kata atau lebih
            spans.forEach(function(span) {
                var text = span.textContent.trim();
                var name = extractName(text);
                if (name.includes(' ')) {
                    name = name.split(' ')[1];
                }
                span.textContent = name;
                spansArray.push({ element: span, name: name });
            });
    
            // Fungsi untuk mengekstrak nama dari teks dan mengembalikan kata kedua jika ada
            function extractName(text) {
                var words = text.split(' ');
                if (words.length > 1) {
                    return words[1];
                }
                return text;
            }
    
            // Mengurutkan elemen-elemen <span> yang tersisa berdasarkan teks yang ada di dalamnya
            spansArray.sort(function(a, b) {
                var textA = a.name.toLowerCase();
                var textB = b.name.toLowerCase();
                return textA.localeCompare(textB);
            });
    
            // Mencari index elemen <span> yang berisi teks "Anda"
            var indexAnda = -1;
            spansArray.forEach(function(span, index) {
                var spanText = span.name.trim();
                if (spanText === "Anda") {
                    indexAnda = index;
                }
            });
    
            // Jika elemen <span> yang berisi teks "Anda" ditemukan
            if (indexAnda !== -1) {
                // Memindahkan elemen <span> yang berisi teks "Anda" ke urutan pertama
                var spanAnda = spansArray.splice(indexAnda, 1)[0];
                spansArray.unshift(spanAnda);
            }
    
            // Mendapatkan parent dari elemen <span>
            var parentElement = document.getElementById("anggota-kelompok-chat");
    
            // Menghapus semua elemen <span> dari parent
            parentElement.innerHTML = "";
    
            spansArray.forEach(function(span) {
                parentElement.appendChild(span.element);
            });
       
    }



    // =======================================================================================
      </script>

    <script>
    let nm = sessionStorage.getItem('nama');
    let nama = document.getElementById('nama');
    
    nama.innerHTML = `<i class="fa-solid fa-user"></i> ${nm}`;
    let nisnUser = sessionStorage.getItem('nisn');
    let groupUser = sessionStorage.getItem('kelompok');


    

    
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- JAVASCRIPT AREA END -->
    
</body>

</html>